{"title":"Lesson 5: SLR-ish: Categorical Covariates","markdown":{"yaml":{"title":"Lesson 5: SLR-ish: Categorical Covariates","author":"Meike Niederhausen and Nicky Wakim","title-slide-attributes":{"data-background-color":"#213c96"},"date":"01/22/2025","categories":["Week 6"],"format":{"revealjs":{"theme":"../simple_NW.scss","chalkboard":true,"slide-number":true,"show-slide-number":"all","width":1955,"height":1100,"footer":"Lesson 5: Categorical Covariates","html-math-method":"mathjax","highlight-style":"ayu"}},"execute":{"freeze":"auto"}},"headingText":"Load the data - update code if the csv file is not in the same location on your computer","containsRefs":false,"markdown":"\n\n```{r}\n#| label: \"setup\" \n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(janitor)\nlibrary(here)\nlibrary(broom)\nlibrary(knitr)\nlibrary(readxl)\nlibrary(gt)\n\n# If you need to download the file, please go to ur shared folder under Data > Slides\ngapm <- read_excel(\"data/Gapminder_vars_2011.xlsx\", \n                   na = \"NA\")  # important!!!! \n\ngapm_sub <- gapm %>% \n  drop_na(LifeExpectancyYrs, FemaleLiteracyRate, FoodSupplykcPPD)\n\nglimpse(gapm_sub)\n```\n\n```{r echo=FALSE}\n# Load the data - update code if the csv file is not in the same location on your computer\ngapm <- read_excel(\"data/gapminder_vars_2011.xlsx\", \n                   na = \"NA\")  # important!!!! \n# na = \"NA\" is telling R that the NA's in the Excel sheet are actual missing values and not character strings\n\n# glimpse(gapm)\n# Note that life expectancy and female literacy rate have different column names in this dataset\n\n# gapm %>% tabyl(four_regions) # no missing values\n\n# Removing all rows (countries) that have \n# a missing value for any of the variables listed in drop_na()\ngapm2 <- gapm %>% # called it gapm2_sub3 to be consistent with Day 7 notes\n  drop_na(LifeExpectancyYrs, four_regions) %>%\n  mutate(four_regions = factor(four_regions, levels = c(\"africa\", \"americas\", \"asia\", \"europe\"), labels = c(\"Africa\", \"Americas\", \"Asia\", \"Europe\"))) %>%\n  rename(income_levels = `World bank, 4 income groups 2017`)\n# dim(gapm)\n# dim(gapm2)\n```\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Why \"SLR-*ish*\"?\n\n- The **strict** definition of simple linear regression: only two variables that are BOTH continuous\n\n \n\n- Common (but kinda wrong) use of simple linear regression: only two variables with outcome continuous and predictor not specified\n\n \n\n- I'm including multi-level categorical covariates in SLR mostly because it's easier to learn now!\n\n\n## Let's map that to our regression analysis process\n\n::: box\n![](../img_slides/arrow2.png){.absolute top=\"13.5%\" right=\"62.1%\" width=\"155\"} ![](../img_slides/arrow2.png){.absolute top=\"13.5%\" right=\"28.4%\" width=\"155\"}![](../img_slides/arrow_back4.png){.absolute top=\"7.5%\" right=\"30.5%\" width=\"820\"} ![](../img_slides/arrow_down.png){.absolute top=\"60.5%\" right=\"48%\" width=\"85\"}\n\n::: columns\n::: {.column width=\"30%\"}\n::: RAP1\n::: RAP1-title\nModel Selection\n:::\n\n::: RAP1-cont\n-   Building a model\n\n-   Selecting variables\n\n-   Prediction vs interpretation\n\n-   Comparing potential models\n:::\n:::\n:::\n\n::: {.column width=\"4%\"}\n:::\n\n::: {.column width=\"30%\"}\n::: RAP2\n::: RAP2-title\nModel Fitting\n:::\n\n::: RAP2-cont\n-   Find best fit line\n\n-   Using OLS in this class\n\n-   Parameter estimation\n\n-   Categorical covariates\n\n-   Interactions\n:::\n:::\n:::\n\n::: {.column width=\"4%\"}\n:::\n\n::: {.column width=\"30%\"}\n::: RAP3\n::: RAP3-title\nModel Evaluation\n:::\n\n::: RAP3-cont\n-   Evaluation of model fit\n-   Testing model assumptions\n-   Residuals\n-   Transformations\n-   Influential points\n-   Multicollinearity\n:::\n:::\n:::\n:::\n:::\n\n::: RAP4\n::: RAP4-title\nModel Use (Inference)\n:::\n\n::: RAP4-cont\n::: columns\n::: {.column width=\"50%\"}\n-   Inference for coefficients\n-   Hypothesis testing for coefficients\n:::\n\n::: {.column width=\"50%\"}\n-   Inference for expected $Y$ given $X$\n:::\n:::\n:::\n:::\n\n# Learning Objectives\n\n::: lob\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n:::\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Still looking at Gapminder Life Expectancy data\n\n-   We will look at life expectancy vs. these world regions\n\n-   [Gapminder uses four world regions](https://www.gapminder.org/fw/four-regions/)\n\n    -   Africa\n    -   The Americas\n    -   Asia\n    -   Europe\n    \n- World region is a **multi-level categorical covariate**: it has four regions \n    \n \n\n- Note: I am calling the expected life expectancy $\\widehat{LE}$\n  - Previously, I have written $\\widehat{\\text{life expectancy}}$\n\n## Linear regression with a categorical covariate (1/2)\n\n::: columns\n::: {.column width=\"33%\"}\nBad option for visualization:\n\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: true\n#| code-fold: true\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_point() +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n\n::: {.column width=\"33%\"}\nGood option for visualization:\n\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: true\n#| code-fold: true\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n\n- Used `geom_jitter()`\n:::\n\n::: {.column width=\"33%\"}\nGood option for visualization:\n\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: true\n#| code-fold: true\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_boxplot() +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## Linear regression with a categorical covariate (2/2)\n\n::: columns\n::: {.column width=\"50%\"}\n-   When using a categorical covariate/predictor (that is not ordered),\n\n    -   We do **NOT**, technically, find a best-fit line\n\n-   Instead we model the **means** of the outcome\n\n    -   For the different levels of the categorical variable\n\n \n\n-   In 511, we used Kruskal-Wallis test and our ANOVA table to test if groups means were statistically different from one another\n\n-   We can do this [using linear models](https://lindeloev.github.io/tests-as-linear/linear_tests_cheat_sheet.pdf) AND we can include other variables in the model\n:::\n\n::: {.column width=\"50%\"}\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## There are different ways to code categorical variables\n\n-   Reference cell coding (sometimes called dummy coding)\n    -   Compares each level of a variable to the omitted (reference) level\n-   Effect coding (sometimes called sum coding or deviation coding)\n    -   Compares deviations from the grand mean\n    -   Not covered in our class\n-   Ordinal encoding (sometimes called scoring)\n    -   Categories have a natural, even spaced ordering\n\n \n\nIf you want to learn more about these and other coding schemes:\n\n-   [Coding Systems for Categorical Variables in Regression Analysis](https://stats.oarc.ucla.edu/spss/faq/coding-systems-for-categorical-variables-in-regression-analysis-2/)\n-   [Categorical Data Encoding Techniques](https://medium.com/aiskunks/categorical-data-encoding-techniques-d6296697a40f#:~:text=Ordinal%20Encoding%20is%20used%20when,variable%20have%20a%20Natural%20Ordering.&text=In%20this%20method%2C%20the%20categories,2%2C%20and%203%2C%20respectively.)\n-   [Coding Schemes for Categorical Variables](https://phillipalday.com/stats/coding.html)\n\n## Building the regression equation: problem with a single coefficient\n\n::: columns\n::: column\n**Previously: simple linear regression**\n\n-   Outcome $Y$ = numerical variable\n-   Predictor $X$ = numerical variable\n\nThe regression (best-fit) line is: $$\\widehat{Y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 \\cdot X $$\n:::\n\n::: column\n**New: what if the explanatory variable is categorical?**\n\n*Naively*, we could write: $\\widehat{Y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 \\cdot X$\n\nOr, with our variables: $$\\widehat{\\textrm{LE}} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 \\cdot \\textrm{WR} $$\n\n-   But what does $\\textrm{WR}$ (world regions) mean in this equation?\n\n    -   What values can it take? How do we represent each region?\n\n \n\n- Note: the above is WRONG\n:::\n:::\n\n## Building the regression equation: how do we map categories to means?\n\n-   If we only have world region in our model and want to map it to an expected life expectancy...\n\n::: columns\n::: {.column width=\"50%\"}\n```{r}\nmeans_LE = gapm2 %>%\n  group_by(four_regions) %>%\n  summarise(mean = mean(LifeExpectancyYrs))\n```\n\n-   We want to create a function that can map each region to life expectancy\n\n    -   If in Africa: $\\widehat{LE} = 61.32$ years\n\n    -   If in the Americas: $\\widehat{LE} = 74.64$ years\n\n    -   If in Asia: $\\widehat{LE} = 71.70$ years\n\n    -   If in Europe: $\\widehat{LE} = 77.61$ years\n\n \n\n-   Can we make one equation for $\\widehat{LE}$ by putting the \"if\" statements within the equation?\n:::\n\n::: {.column width=\"50%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 22), \n        axis.text = element_text(size = 22), \n        title = element_text(size = 22))\n```\n:::\n:::\n\n## Building the regression equation: Indicator functions\n\n-   In order to represent each region in the equation, we need to introduce a new function:\n\n    -   Indicator function:\n\n    $$I(X = x) \\text{ or } I(x) = \n    \\left\\{\n    \\begin{array}{@{}ll@{}}\n     1, & \\text{if}\\ X = x \\\\\n      0, & \\text{else}\n     \\end{array}\\right. $$\n\n    -   This basically a binary yes/no if $X$ is a specific value $x$\n\n-   For example, if we want to identify a country as being in the Americas region, we can make:\n\n    $$I(WR = \\text{Americas}) \\text{ or }I(\\text{Americas}) = \n    \\left\\{\n    \\begin{array}{@{}ll@{}}\n     1, & \\text{if}\\ WR = \\text{Americas} \\\\\n      0, & \\text{else}\n     \\end{array}\\right. $$\n\n## Poll Everywhere Question 1\n\n\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n\n::: lob\n2.  Write the regression equation for a categorical variable using reference cell coding\n:::\n\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Building the regression equation: Indicators in our equation\n\n::: columns\n::: {.column width=\"50%\"}\n$$\\begin{aligned}\n\\widehat{\\textrm{LE}} = & `r round(means_LE$mean[1], 2)` \\cdot I(\\text{Africa}) + `r round(means_LE$mean[2], 2)` \\cdot I(\\text{Americas}) + \\\\ &`r round(means_LE$mean[3], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4], 2)` \\cdot I(\\text{Europe})\n\\end{aligned}$$\n\n-   However, a linear regression equation still requires an intercept!\n\n    -   So one of our regions need to become our \"reference\" group\n    -   We'll use Africa as our reference\n    -   That means we need to adjust all the numbers\n\n$$\\begin{aligned}\n\\widehat{\\textrm{LE}} = & `r round(means_LE$mean[1], 2)` + `r round(means_LE$mean[2]-means_LE$mean[1], 2)` \\cdot I(\\text{Americas}) + \\\\ &`r round(means_LE$mean[3]-means_LE$mean[1], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4]-means_LE$mean[1], 2)` \\cdot I(\\text{Europe}) \\\\\n\\widehat{\\textrm{LE}} = & \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) + \\\\ & \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})\n\\end{aligned}$$\n:::\n\n::: {.column width=\"50%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 22), \n        axis.text = element_text(size = 22), \n        title = element_text(size = 22))\n```\n:::\n:::\n\n## Viewing the regression equation another way\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) + \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n::: columns\n::: {.column width=\"60%\"}\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| World region | Regression equation for WR                                                                                                                                  | Average Life Expectancy for WR                              |\n+==============+=============================================================================================================================================================+=============================================================+\n| Africa       | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 0 + \\\\ & \\widehat\\beta_2 \\cdot 0 + \\widehat\\beta_3 \\cdot 0 \\end{aligned}$ | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0$                   |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| Americas     | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 1+ \\\\ & \\widehat\\beta_2 \\cdot 0 + \\widehat\\beta_3 \\cdot 0 \\end{aligned}$  | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0 + \\widehat\\beta_1$ |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| Asia         | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 0 + \\\\ & \\widehat\\beta_2 \\cdot 1 + \\widehat\\beta_3 \\cdot 0 \\end{aligned}$ | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0 + \\widehat\\beta_2$ |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| Europe       | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 0 + \\\\ & \\widehat\\beta_2 \\cdot 0 + \\widehat\\beta_3 \\cdot 1 \\end{aligned}$ | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0 + \\widehat\\beta_3$ |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n:::\n\n::: {.column width=\"40%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 22), \n        axis.text = element_text(size = 22), \n        title = element_text(size = 22))\n```\n:::\n:::\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n\n::: lob\n3.  Calculate and interpret coefficients for reference cell coding\n:::\n\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Interpretation of regression equation coefficients\n\n-   Remember: expected, mean, and average are interchangeable\n\n+---------------------+--------------------------------------------------------------------+\n| Coefficient         | Interpretation                                                     |\n+=====================+====================================================================+\n| $\\widehat{\\beta}_0$ | Expected/mean/average life expectancy of Africa                    |\n+---------------------+--------------------------------------------------------------------+\n| $\\widehat{\\beta}_1$ | Difference in mean life expectancy of the Americas and Africa -OR- |\n|                     |                                                                    |\n|                     | Mean difference in life expectancy of the Americas and Africa      |\n+---------------------+--------------------------------------------------------------------+\n| $\\widehat{\\beta}_2$ | Difference in mean life expectancy between Asia and Africa -OR-    |\n|                     |                                                                    |\n|                     | Mean difference in life expectancy between Asia and Africa         |\n+---------------------+--------------------------------------------------------------------+\n| $\\widehat{\\beta}_3$ | Difference in mean life expectancy between Europe and Africa -OR-  |\n|                     |                                                                    |\n|                     | Mean difference in life expectancy between Europe and Africa       |\n+---------------------+--------------------------------------------------------------------+\n\n## Poll Everywhere Question 2\n\n\n\n## Regression table with `lm()` function\n\n```{r}\n#| echo: true\nmodel1 <- lm(LifeExpectancyYrs ~ four_regions, data = gapm2)\ntidy(model1, conf.int=T) %>% gt() %>% tab_options(table.font.size = 38) %>% \n  fmt_number(decimals = 2)\n```\n\n$$\\widehat{\\textrm{LE}} = `r round(means_LE$mean[1], 2)` + `r round(means_LE$mean[2]-means_LE$mean[1], 2)` \\cdot I(\\text{Americas}) + `r round(means_LE$mean[3]-means_LE$mean[1], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4]-means_LE$mean[1], 2)` \\cdot I(\\text{Europe})$$\n\n-   Which world region did R choose as the reference level?\n\n-   How you would calculate the mean life expectancies of world regions using *only* the results from the regression table?\n\n## Bringing in the numbers/units/95% CI\n\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| Coefficient         | Interpretation                                                                                                       |\n+=====================+======================================================================================================================+\n| $\\widehat{\\beta}_0$ | Average life expectancy of countries in Africa is 61.32 years (95% CI: 59.81, 62.83).                                |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| $\\widehat{\\beta}_1$ | The difference in mean life expectancy between countries in the Americas and Africa is 13.32 (95% CI: 10.89, 15.74). |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| $\\widehat{\\beta}_2$ | The difference in mean life expectancy between countries in the Americas and Africa is 10.38 (95% CI: 8.25, 12.51).  |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| $\\widehat{\\beta}_3$ | The difference in mean life expectancy between countries in Europe and Africa is 18.52 (95% CI: 14.05, 18.52).       |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n\n \n\n-   Don't forget that we can use the confidence intervals to assess whether the mean difference with Africa is significant or not\n\n## We can also use R to report each region's average life expectancy\n\n**Find the 95% CI's for the mean life expectancy for the Americas, Asia, and Europe**\n\n-   Use the base R `predict()` function (see Lesson 4 for more info)\n-   Requires specification of a `newdata` \"value\"\n\n```{r}\n#| echo: true\nnewdata <- data.frame(four_regions = c(\"Africa\", \"Americas\", \"Asia\", \"Europe\")) \n\n```\n\n::: columns\n::: {.column width=\"50%\"}\n```{r}\n#| echo: true\n(pred = predict(model1, \n                newdata=newdata, \n                interval=\"confidence\"))\n```\n:::\n\n::: {.column width=\"50%\"}\n::: fact\n::: fact-title\nInterpretations\n:::\n\n::: fact-cont\n-   The average life expectancy for countries in the Americas is `r round(pred[2,1], 2)` years (95% CI: `r round(pred[2,2], 2)`, `r round(pred[2,3], 2)`).\n-   The average life expectancy for countries in Asia is `r round(pred[3,1], 2)` years (95% CI: `r round(pred[3,2], 2)`, `r round(pred[3,3], 2)`).\n-   The average life expectancy for countries in Europe is `r round(pred[4,1], 2)` years (95% CI: `r round(pred[4,2], 2)`, `r round(pred[4,3], 2)`).\n:::\n:::\n:::\n:::\n\n## Another way to look at coefficient values\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) +  \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n```{r}\n#| echo: true\n#| code-fold: true\n\n# means of each level of `four_regions`\ngapm2_ave <- gapm2 %>% \n  group_by(four_regions) %>% \n  summarise(\n    life_ave = mean(LifeExpectancyYrs))\n\n# mean of `africa`\nmean_africa <- gapm2_ave %>% \n  filter(four_regions == \"Africa\") %>% \n  pull(life_ave)\n\n# differences in means between levels of `four_regions` and `africa`\ngapm2_ave_diff <- gapm2_ave %>% \n  mutate(`Difference with Africa` = life_ave - mean_africa) %>%\n  rename(`World regions` = four_regions, \n         `Average life expectancy` = life_ave)\n\n# At the beginning of the Rmd we loaded knitr, which is where the kable command is from\n# library(knitr)\ngapm2_ave_diff %>% kable(\n  digits = 1,\n  format = \"markdown\"\n  ) \n```\n\n$$\\widehat{\\textrm{LE}} = `r round(means_LE$mean[1], 2)` + `r round(means_LE$mean[2]-means_LE$mean[1], 2)` \\cdot I(\\text{Americas}) + `r round(means_LE$mean[3]-means_LE$mean[1], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4]-means_LE$mean[1], 2)` \\cdot I(\\text{Europe})$$\n\n# 10 minute break here?\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n\n::: lob\n4.  Change the reference level in a categorical variable for reference cell coding\n:::\n\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Reference levels\n\n**Why is `Africa` not one of the variables in the regression equation?**\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) +  \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n-   Categorical variables have to have at least 2 levels. If they have 2 levels, we call them *binary*\n\n \n\n-   We choose one level as our **reference level** to which all other levels of the categorical variable are compared\n\n    -   The levels $\\text{Americas}, \\text{Asia}, \\text{Europe}$ are compared to the level $\\text{Africa}$\n\n \n\n-   The **intercept** of the regression equation is the *mean of the outcome restricted to the reference level*\n\n    -   Recall that the intercept is the mean life expectancy of Africa, which was our reference level\n\n \n\n-   **If the categorical variable has** $r$ levels, then we need $r-1$ variables/coefficients to model it!\n\n## We can change the reference level to `Europe` (1/2)\n\n-   Suppose we want to compare the mean life expectancies of world regions to the $\\text{Europe}$ level instead of $\\text{Africa}$\n\n-   Below is the estimated regression equation for when $Africa$ is the reference level\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) +  \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n-   Update the variables to make $Europe$ the reference level:\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Africa}) +  \\widehat\\beta_2 \\cdot I(\\text{Americas}) + \\widehat\\beta_3 \\cdot I(\\text{Asia})$$\n\n## We can change the reference level to `Europe` (2/2)\n\n-   Now update the coefficients of the regression equation using the output below.\n\n```{r echo=FALSE}\nmean_europe <- gapm2_ave %>% \n  filter(four_regions == \"Europe\") %>% \n  pull(life_ave)\n\n# mean_europe\n\ngapm2_ave_diff2 <- gapm2_ave %>% \n  mutate(\n    `Difference with Europe` = life_ave - mean_europe\n  ) %>%\n  rename(`World regions` = four_regions, \n         `Average life expectancy` = life_ave)\n\n# At the beginning of the Rmd I loaded knitr, which is where the kable command is from\n# library(knitr)\ngapm2_ave_diff2 %>% kable(\n  digits = 2,\n  format = \"markdown\"\n  ) \n```\n\n```{r echo=FALSE}\nb0 <- mean_europe\n\ncoeff_europe <- gapm2_ave_diff2$`Difference with Europe`\n# coeff_europe\n\nb1 <- coeff_europe[1]\nb2 <- coeff_europe[2]\nb3 <- coeff_europe[3]\n# b0; b1; b2; b3\n```\n\n$$\\widehat{\\textrm{LE}} = `r round(mean_europe,2)` `r round(coeff_europe[1],2)` \\cdot I(\\text{Africa}) `r round(coeff_europe[2],2)` \\cdot I(\\text{Americas}) `r round(coeff_europe[3],2)` \\cdot I(\\text{Asia})$$\n\n## R: Change reference level to `Europe` (1/2)\n\n-   `four_regions` data type was originally a `character` - check this with `str()`\n\n```{r}\n#| echo: true\nstr(gapm$four_regions) \n```\n\n-   In order to change the reference level, we need to convert it to data type `factor`\n\n    -   I also did this at the beginning to capitalize each region\n\n```{r}\n#| echo: true\n\ngapm_ex = gapm %>% \n mutate(\n   four_regions = factor(four_regions, \n                         levels = c(\"africa\", \"americas\", \"asia\", \"europe\"), \n                         labels = c(\"Africa\", \"Americas\", \"Asia\", \"Europe\"))\n   )\nstr(gapm_ex$four_regions) \nlevels(gapm_ex$four_regions) # order of factor levels\n```\n\n## R: Change reference level to `Europe` (2/2)\n\n-   Now change the order of the factor levels\n-   Code below uses `fct_relevel()` from the `forcats` package that gets loaded as a part of the `tidyverse`\n-   *Any levels not mentioned will be left in their existing order, after the explicitly mentioned levels.*\n\n```{r}\n#| echo: true\ngapm2 <- gapm2 %>% \n  mutate(\n    four_regions = fct_relevel(four_regions, \"Europe\")\n    )\n```\n\n- Check the order:\n```{r}\n#| echo: true\n\nlevels(gapm2$four_regions)\n```\n\n## R: Run model with `Europe` as the reference level\n\n```{r}\n#| echo: true\nlevels(gapm2$four_regions)\nmodel2 <- lm(LifeExpectancyYrs ~ four_regions, data = gapm2)\ntidy(model2) %>% gt() %>% tab_options(table.font.size = 35) %>% \n  fmt_number(decimals = 2)\n```\n\n$$\\begin{aligned}\\widehat{\\textrm{LE}} &=  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Africa}) +  \\widehat\\beta_2 \\cdot I(\\text{Americas}) + \\widehat\\beta_3 \\cdot I(\\text{Asia}) \\\\ \\widehat{\\textrm{LE}} &= `r round(mean_europe,2)` `r round(coeff_europe[1],2)` \\cdot I(\\text{Africa}) `r round(coeff_europe[2],2)` \\cdot I(\\text{Americas}) `r round(coeff_europe[3],2)` \\cdot I(\\text{Asia}) \\end{aligned}$$\n\n## Fitted values & residuals\n\n::: columns\n::: {.column width=\"40%\"}\nSimilar to as before:\n\n-   **Observed values** $Y$ are the values in the dataset\n\n-   **Fitted values** $\\widehat{Y}$ are the values that ~~fall on the best-fit line for a specific value of x~~ are the *means of the outcome stratified by the categorical predictor's levels*\n\n-   **Residuals** ($\\widehat{\\epsilon} = Y - \\widehat{Y}$) are the differences between the two\n:::\n\n::: {.column width=\"60%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## Fitted values are the same as the means\n\n```{r fig.height=6, fig.width=6, warning=F}\n#| echo: true\n#| fig-align: center\n\nm1_aug <- augment(model1)\n\nggplot(m1_aug, aes(x = four_regions, y = .fitted)) + geom_point() +\n  theme(axis.text = element_text(size = 22), axis.title = element_text(size = 22))\n```\n\n\n## Residual plots (now the spread within each region)\n\n```{r fig.height=6, fig.width=6, warning=F}\n#| echo: true\n#| fig-align: center\nggplot(m1_aug, aes(x=.resid)) + geom_histogram() + \n  theme(axis.text = element_text(size = 22), title = element_text(size = 22))\n```\n\n## Poll Everywhere Question 3\n\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n\n::: lob\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n:::\n\n## Let's look at life expectancy vs. four income levels\n\n-   [Gapminder discusses individual income levels](https://www.gapminder.org/fw/income-levels/)\n\n \n\n-   **Income levels for a country** is based on average GDP per capita, and grouped into:\n\n    -   Low income\n    \n    -   Lower middle income\n    \n    -   Upper middle income\n    \n    -   High income\n\n## Visualizing the ordinal variable, income levels\n\n::: columns\n::: {.column width=\"40%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = income_levels, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n\n::: {.column width=\"60%\"}\nA few changes needed:\n\n-   Put the income levels in order\n\n```{r}\n#| echo: true\ngapm2 = gapm2 %>%\n mutate(income_levels = factor(income_levels, \n            ordered = T, \n            levels = c(\"Low income\", \n            \"Lower middle income\", \n            \"Upper middle income\", \n            \"High income\")))\n```\n\n-   Make the income levels readable\n\n    -   [How to Rotate Axis Labels in ggplot2?](https://www.r-bloggers.com/2021/09/how-to-rotate-axis-labels-in-ggplot2/)\n:::\n:::\n\n## Much better: Visualizing the ordinal variable, income levels {.smaller}\n\n::: columns\n::: {.column width=\"60%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| eval: false\n#| echo: true\nggplot(gapm2, aes(x = income_levels, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20), \n        axis.text.x=element_text(angle = 20, vjust = 1, hjust=1))\n```\n:::\n\n::: {.column width=\"40%\"}\n```{r fig.height=8, fig.width=7, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = income_levels, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20), \n        axis.text.x=element_text(angle = 20, vjust = 1, hjust=1))\n```\n:::\n:::\n\n## How can we code this variable?\n\nWe have two options:\n\n::: columns\n::: column\n::: definition\n::: def-title\nTreat the levels as nominal, and use reference cell coding\n:::\n\n::: def-cont\n-   Like we did with world regions\n\n-   This option will not break the linearity assumption\n\n-   For $g$ categories of the variable, we will have $g-1$ coefficients to estimate\n:::\n:::\n:::\n\n::: column\n::: proof1\n::: proof-title\nUse the ordinal values to score the levels and treat as a numerical variable\n:::\n\n::: proof-cont\n-   Even if a variable is inherently ordered, we need to check that linearity holds if categories are represented as numbers\n\n-   This way of coding preserves more power in the model (less coefficients to estimate means more power)\n\n-   Only one coefficient to estimate\n:::\n:::\n:::\n:::\n\n## Some important considerations when scoring ordinal variables\n\n-   Even if a variable is inherently ordered, we need to check that linearity holds if categories are represented as numbers (more in next lessons)\n    - Linearity is an assumption of linear regression: that the relationship between X and Y is linear\n\n \n\n-   Assumes differences between adjacent groups are equal\n\n    -   Income levels are pre-set groups by Gapminder\n    -   Might be hard to interpret \"every 1-level increase in income level\"\n   \n \n \n-   Is the variable part of the main relationship that you are investigating? (even if linearity holds)\n\n    -   If yes, consider leaving as reference cell coding unless the interpretation makes sense\n    \n    -   If no, and just needed as an adjustment in your model, then power benefit of scoring might be worth it!\n\n## Check that linearity holds for income levels\n\n::: columns\n::: {.column width=\"40%\"}\n-   Using visual assessment, linearity holds for our income levels (more in next lessons)\n\n-   We can use the ordinal encoding for income levels\n:::\n\n::: {.column width=\"60%\"}\n```{r fig.height=8, fig.width=7.5, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = as.numeric(income_levels), y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  geom_smooth(method = lm, se = FALSE) + \n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## Poll Everywhere Question 4\n\n## Ordinal coding / Scoring\n\n-   Map each income level to a number\n\n-   Usually start at 1\n\n| Income Level        | Score |\n|---------------------|-------|\n| Low income          | 1     |\n| Lower middle income | 2     |\n| Upper middle income | 3     |\n| High income         | 4     |\n\n```{r}\n#| echo: true\ngapm2 = gapm2 %>%\n  mutate(income_num = as.numeric(income_levels))\nstr(gapm2$income_num)\n```\n\n## Run the model with the scored income\n\n```{r}\n#| echo: true\n\nmod_inc2 = lm(LifeExpectancyYrs ~ income_num, data = gapm2)\ntidy(mod_inc2) %>% gt() %>% tab_options(table.font.size = 37) %>%\n  fmt_number(decimals = 2)\n```\n\n$$\\begin{aligned}\n\\widehat{\\textrm{LE}} &=  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot \\text{Income level} \\\\\n\\widehat{\\textrm{LE}} &=  54.01 + 6.25 \\cdot \\text{Income level}\n\\end{aligned}$$\n\n-   Keep in mind: We cannot calculate the expected outcome outside of the scoring values\n\n    -   For example, we cannot find the mean life expectancy for an income level of 1.5\n\n## Interpreting the model\n\n```{r}\ntidy(mod_inc2, conf.int=T) %>% gt() %>% tab_options(table.font.size = 37) %>%\n  fmt_number(decimals = 2)\n```\n\n$$\\widehat{\\textrm{LE}} =  54.01 + 6.25 \\cdot \\text{Income level}$$\n\n-   **Interpreting the intercept:** At an income level of 0, mean life expectancy is 54.01 (95% CI: 51.92, 56.10).\n\n    -   Note: this does not make sense because there is no income level of 0!\n    \n-   **Interpreting the coefficient for income:** For every 1-level increase in income level, mean life expectancy increases 6.25 years (95% CI: 5.52, 6.98).\n\n## What if life expectancy vs. income level looked like this?\n\n::: columns\n::: {.column width=\"50%\"}\n```{r}\nset.seed(40)\ngapm2 = gapm2 %>% rowwise() %>% \n  mutate(life_exp_sim = rnorm(1, mean = 23*log(8*(income_num-0.7)), sd=5))\n```\n\n```{r fig.height=8, fig.width=7.5, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = income_num, y = life_exp_sim)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  geom_smooth(method = lm, se = FALSE) + \n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n\n::: {.column width=\"50%\"}\n-   No longer maintaining the linearity assumption\n-   Need to use reference cell coding\n\n \n\n-   We would fit the following model: \n$$\\begin{aligned}\n\\textrm{LE} = & \\beta_0 + \\beta_1 \\cdot I(\\text{Lower middle income}) + \\\\ & \\beta_2 \\cdot I(\\text{Upper middle income}) + \\\\ & \\beta_3 \\cdot I(\\text{High income}) + \\epsilon\n\\end{aligned}$$\n:::\n:::\n\n## If time...\n\n[Let's walk through categorical variables that have multiple selections](https://weallcount.com/2022/10/27/4-approaches-to-multiple-race-questions/)\n\n-   So each group is not mutually exclusive\n\n-   We could make an indicator for each category, but individuals could be a part of multiple categories\n\n \n\n-   Also, thinking about income levels - can we combine two groups to make one??\n\n","srcMarkdownNoYaml":"\n\n```{r}\n#| label: \"setup\" \n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(janitor)\nlibrary(here)\nlibrary(broom)\nlibrary(knitr)\nlibrary(readxl)\nlibrary(gt)\n\n# Load the data - update code if the csv file is not in the same location on your computer\n# If you need to download the file, please go to ur shared folder under Data > Slides\ngapm <- read_excel(\"data/Gapminder_vars_2011.xlsx\", \n                   na = \"NA\")  # important!!!! \n\ngapm_sub <- gapm %>% \n  drop_na(LifeExpectancyYrs, FemaleLiteracyRate, FoodSupplykcPPD)\n\nglimpse(gapm_sub)\n```\n\n```{r echo=FALSE}\n# Load the data - update code if the csv file is not in the same location on your computer\ngapm <- read_excel(\"data/gapminder_vars_2011.xlsx\", \n                   na = \"NA\")  # important!!!! \n# na = \"NA\" is telling R that the NA's in the Excel sheet are actual missing values and not character strings\n\n# glimpse(gapm)\n# Note that life expectancy and female literacy rate have different column names in this dataset\n\n# gapm %>% tabyl(four_regions) # no missing values\n\n# Removing all rows (countries) that have \n# a missing value for any of the variables listed in drop_na()\ngapm2 <- gapm %>% # called it gapm2_sub3 to be consistent with Day 7 notes\n  drop_na(LifeExpectancyYrs, four_regions) %>%\n  mutate(four_regions = factor(four_regions, levels = c(\"africa\", \"americas\", \"asia\", \"europe\"), labels = c(\"Africa\", \"Americas\", \"Asia\", \"Europe\"))) %>%\n  rename(income_levels = `World bank, 4 income groups 2017`)\n# dim(gapm)\n# dim(gapm2)\n```\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Why \"SLR-*ish*\"?\n\n- The **strict** definition of simple linear regression: only two variables that are BOTH continuous\n\n \n\n- Common (but kinda wrong) use of simple linear regression: only two variables with outcome continuous and predictor not specified\n\n \n\n- I'm including multi-level categorical covariates in SLR mostly because it's easier to learn now!\n\n\n## Let's map that to our regression analysis process\n\n::: box\n![](../img_slides/arrow2.png){.absolute top=\"13.5%\" right=\"62.1%\" width=\"155\"} ![](../img_slides/arrow2.png){.absolute top=\"13.5%\" right=\"28.4%\" width=\"155\"}![](../img_slides/arrow_back4.png){.absolute top=\"7.5%\" right=\"30.5%\" width=\"820\"} ![](../img_slides/arrow_down.png){.absolute top=\"60.5%\" right=\"48%\" width=\"85\"}\n\n::: columns\n::: {.column width=\"30%\"}\n::: RAP1\n::: RAP1-title\nModel Selection\n:::\n\n::: RAP1-cont\n-   Building a model\n\n-   Selecting variables\n\n-   Prediction vs interpretation\n\n-   Comparing potential models\n:::\n:::\n:::\n\n::: {.column width=\"4%\"}\n:::\n\n::: {.column width=\"30%\"}\n::: RAP2\n::: RAP2-title\nModel Fitting\n:::\n\n::: RAP2-cont\n-   Find best fit line\n\n-   Using OLS in this class\n\n-   Parameter estimation\n\n-   Categorical covariates\n\n-   Interactions\n:::\n:::\n:::\n\n::: {.column width=\"4%\"}\n:::\n\n::: {.column width=\"30%\"}\n::: RAP3\n::: RAP3-title\nModel Evaluation\n:::\n\n::: RAP3-cont\n-   Evaluation of model fit\n-   Testing model assumptions\n-   Residuals\n-   Transformations\n-   Influential points\n-   Multicollinearity\n:::\n:::\n:::\n:::\n:::\n\n::: RAP4\n::: RAP4-title\nModel Use (Inference)\n:::\n\n::: RAP4-cont\n::: columns\n::: {.column width=\"50%\"}\n-   Inference for coefficients\n-   Hypothesis testing for coefficients\n:::\n\n::: {.column width=\"50%\"}\n-   Inference for expected $Y$ given $X$\n:::\n:::\n:::\n:::\n\n# Learning Objectives\n\n::: lob\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n:::\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Still looking at Gapminder Life Expectancy data\n\n-   We will look at life expectancy vs. these world regions\n\n-   [Gapminder uses four world regions](https://www.gapminder.org/fw/four-regions/)\n\n    -   Africa\n    -   The Americas\n    -   Asia\n    -   Europe\n    \n- World region is a **multi-level categorical covariate**: it has four regions \n    \n \n\n- Note: I am calling the expected life expectancy $\\widehat{LE}$\n  - Previously, I have written $\\widehat{\\text{life expectancy}}$\n\n## Linear regression with a categorical covariate (1/2)\n\n::: columns\n::: {.column width=\"33%\"}\nBad option for visualization:\n\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: true\n#| code-fold: true\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_point() +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n\n::: {.column width=\"33%\"}\nGood option for visualization:\n\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: true\n#| code-fold: true\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n\n- Used `geom_jitter()`\n:::\n\n::: {.column width=\"33%\"}\nGood option for visualization:\n\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: true\n#| code-fold: true\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_boxplot() +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## Linear regression with a categorical covariate (2/2)\n\n::: columns\n::: {.column width=\"50%\"}\n-   When using a categorical covariate/predictor (that is not ordered),\n\n    -   We do **NOT**, technically, find a best-fit line\n\n-   Instead we model the **means** of the outcome\n\n    -   For the different levels of the categorical variable\n\n \n\n-   In 511, we used Kruskal-Wallis test and our ANOVA table to test if groups means were statistically different from one another\n\n-   We can do this [using linear models](https://lindeloev.github.io/tests-as-linear/linear_tests_cheat_sheet.pdf) AND we can include other variables in the model\n:::\n\n::: {.column width=\"50%\"}\n```{r fig.height=7, fig.width=7, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## There are different ways to code categorical variables\n\n-   Reference cell coding (sometimes called dummy coding)\n    -   Compares each level of a variable to the omitted (reference) level\n-   Effect coding (sometimes called sum coding or deviation coding)\n    -   Compares deviations from the grand mean\n    -   Not covered in our class\n-   Ordinal encoding (sometimes called scoring)\n    -   Categories have a natural, even spaced ordering\n\n \n\nIf you want to learn more about these and other coding schemes:\n\n-   [Coding Systems for Categorical Variables in Regression Analysis](https://stats.oarc.ucla.edu/spss/faq/coding-systems-for-categorical-variables-in-regression-analysis-2/)\n-   [Categorical Data Encoding Techniques](https://medium.com/aiskunks/categorical-data-encoding-techniques-d6296697a40f#:~:text=Ordinal%20Encoding%20is%20used%20when,variable%20have%20a%20Natural%20Ordering.&text=In%20this%20method%2C%20the%20categories,2%2C%20and%203%2C%20respectively.)\n-   [Coding Schemes for Categorical Variables](https://phillipalday.com/stats/coding.html)\n\n## Building the regression equation: problem with a single coefficient\n\n::: columns\n::: column\n**Previously: simple linear regression**\n\n-   Outcome $Y$ = numerical variable\n-   Predictor $X$ = numerical variable\n\nThe regression (best-fit) line is: $$\\widehat{Y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 \\cdot X $$\n:::\n\n::: column\n**New: what if the explanatory variable is categorical?**\n\n*Naively*, we could write: $\\widehat{Y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 \\cdot X$\n\nOr, with our variables: $$\\widehat{\\textrm{LE}} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 \\cdot \\textrm{WR} $$\n\n-   But what does $\\textrm{WR}$ (world regions) mean in this equation?\n\n    -   What values can it take? How do we represent each region?\n\n \n\n- Note: the above is WRONG\n:::\n:::\n\n## Building the regression equation: how do we map categories to means?\n\n-   If we only have world region in our model and want to map it to an expected life expectancy...\n\n::: columns\n::: {.column width=\"50%\"}\n```{r}\nmeans_LE = gapm2 %>%\n  group_by(four_regions) %>%\n  summarise(mean = mean(LifeExpectancyYrs))\n```\n\n-   We want to create a function that can map each region to life expectancy\n\n    -   If in Africa: $\\widehat{LE} = 61.32$ years\n\n    -   If in the Americas: $\\widehat{LE} = 74.64$ years\n\n    -   If in Asia: $\\widehat{LE} = 71.70$ years\n\n    -   If in Europe: $\\widehat{LE} = 77.61$ years\n\n \n\n-   Can we make one equation for $\\widehat{LE}$ by putting the \"if\" statements within the equation?\n:::\n\n::: {.column width=\"50%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 22), \n        axis.text = element_text(size = 22), \n        title = element_text(size = 22))\n```\n:::\n:::\n\n## Building the regression equation: Indicator functions\n\n-   In order to represent each region in the equation, we need to introduce a new function:\n\n    -   Indicator function:\n\n    $$I(X = x) \\text{ or } I(x) = \n    \\left\\{\n    \\begin{array}{@{}ll@{}}\n     1, & \\text{if}\\ X = x \\\\\n      0, & \\text{else}\n     \\end{array}\\right. $$\n\n    -   This basically a binary yes/no if $X$ is a specific value $x$\n\n-   For example, if we want to identify a country as being in the Americas region, we can make:\n\n    $$I(WR = \\text{Americas}) \\text{ or }I(\\text{Americas}) = \n    \\left\\{\n    \\begin{array}{@{}ll@{}}\n     1, & \\text{if}\\ WR = \\text{Americas} \\\\\n      0, & \\text{else}\n     \\end{array}\\right. $$\n\n## Poll Everywhere Question 1\n\n\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n\n::: lob\n2.  Write the regression equation for a categorical variable using reference cell coding\n:::\n\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Building the regression equation: Indicators in our equation\n\n::: columns\n::: {.column width=\"50%\"}\n$$\\begin{aligned}\n\\widehat{\\textrm{LE}} = & `r round(means_LE$mean[1], 2)` \\cdot I(\\text{Africa}) + `r round(means_LE$mean[2], 2)` \\cdot I(\\text{Americas}) + \\\\ &`r round(means_LE$mean[3], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4], 2)` \\cdot I(\\text{Europe})\n\\end{aligned}$$\n\n-   However, a linear regression equation still requires an intercept!\n\n    -   So one of our regions need to become our \"reference\" group\n    -   We'll use Africa as our reference\n    -   That means we need to adjust all the numbers\n\n$$\\begin{aligned}\n\\widehat{\\textrm{LE}} = & `r round(means_LE$mean[1], 2)` + `r round(means_LE$mean[2]-means_LE$mean[1], 2)` \\cdot I(\\text{Americas}) + \\\\ &`r round(means_LE$mean[3]-means_LE$mean[1], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4]-means_LE$mean[1], 2)` \\cdot I(\\text{Europe}) \\\\\n\\widehat{\\textrm{LE}} = & \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) + \\\\ & \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})\n\\end{aligned}$$\n:::\n\n::: {.column width=\"50%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 22), \n        axis.text = element_text(size = 22), \n        title = element_text(size = 22))\n```\n:::\n:::\n\n## Viewing the regression equation another way\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) + \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n::: columns\n::: {.column width=\"60%\"}\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| World region | Regression equation for WR                                                                                                                                  | Average Life Expectancy for WR                              |\n+==============+=============================================================================================================================================================+=============================================================+\n| Africa       | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 0 + \\\\ & \\widehat\\beta_2 \\cdot 0 + \\widehat\\beta_3 \\cdot 0 \\end{aligned}$ | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0$                   |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| Americas     | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 1+ \\\\ & \\widehat\\beta_2 \\cdot 0 + \\widehat\\beta_3 \\cdot 0 \\end{aligned}$  | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0 + \\widehat\\beta_1$ |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| Asia         | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 0 + \\\\ & \\widehat\\beta_2 \\cdot 1 + \\widehat\\beta_3 \\cdot 0 \\end{aligned}$ | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0 + \\widehat\\beta_2$ |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n| Europe       | $\\begin{aligned} \\widehat{\\textrm{LE}} = &\\widehat\\beta_0 + \\widehat\\beta_1 \\cdot 0 + \\\\ & \\widehat\\beta_2 \\cdot 0 + \\widehat\\beta_3 \\cdot 1 \\end{aligned}$ | $\\widehat{\\textrm{LE}} = \\widehat\\beta_0 + \\widehat\\beta_3$ |\n+--------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+\n:::\n\n::: {.column width=\"40%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 22), \n        axis.text = element_text(size = 22), \n        title = element_text(size = 22))\n```\n:::\n:::\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n\n::: lob\n3.  Calculate and interpret coefficients for reference cell coding\n:::\n\n4.  Change the reference level in a categorical variable for reference cell coding\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Interpretation of regression equation coefficients\n\n-   Remember: expected, mean, and average are interchangeable\n\n+---------------------+--------------------------------------------------------------------+\n| Coefficient         | Interpretation                                                     |\n+=====================+====================================================================+\n| $\\widehat{\\beta}_0$ | Expected/mean/average life expectancy of Africa                    |\n+---------------------+--------------------------------------------------------------------+\n| $\\widehat{\\beta}_1$ | Difference in mean life expectancy of the Americas and Africa -OR- |\n|                     |                                                                    |\n|                     | Mean difference in life expectancy of the Americas and Africa      |\n+---------------------+--------------------------------------------------------------------+\n| $\\widehat{\\beta}_2$ | Difference in mean life expectancy between Asia and Africa -OR-    |\n|                     |                                                                    |\n|                     | Mean difference in life expectancy between Asia and Africa         |\n+---------------------+--------------------------------------------------------------------+\n| $\\widehat{\\beta}_3$ | Difference in mean life expectancy between Europe and Africa -OR-  |\n|                     |                                                                    |\n|                     | Mean difference in life expectancy between Europe and Africa       |\n+---------------------+--------------------------------------------------------------------+\n\n## Poll Everywhere Question 2\n\n\n\n## Regression table with `lm()` function\n\n```{r}\n#| echo: true\nmodel1 <- lm(LifeExpectancyYrs ~ four_regions, data = gapm2)\ntidy(model1, conf.int=T) %>% gt() %>% tab_options(table.font.size = 38) %>% \n  fmt_number(decimals = 2)\n```\n\n$$\\widehat{\\textrm{LE}} = `r round(means_LE$mean[1], 2)` + `r round(means_LE$mean[2]-means_LE$mean[1], 2)` \\cdot I(\\text{Americas}) + `r round(means_LE$mean[3]-means_LE$mean[1], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4]-means_LE$mean[1], 2)` \\cdot I(\\text{Europe})$$\n\n-   Which world region did R choose as the reference level?\n\n-   How you would calculate the mean life expectancies of world regions using *only* the results from the regression table?\n\n## Bringing in the numbers/units/95% CI\n\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| Coefficient         | Interpretation                                                                                                       |\n+=====================+======================================================================================================================+\n| $\\widehat{\\beta}_0$ | Average life expectancy of countries in Africa is 61.32 years (95% CI: 59.81, 62.83).                                |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| $\\widehat{\\beta}_1$ | The difference in mean life expectancy between countries in the Americas and Africa is 13.32 (95% CI: 10.89, 15.74). |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| $\\widehat{\\beta}_2$ | The difference in mean life expectancy between countries in the Americas and Africa is 10.38 (95% CI: 8.25, 12.51).  |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n| $\\widehat{\\beta}_3$ | The difference in mean life expectancy between countries in Europe and Africa is 18.52 (95% CI: 14.05, 18.52).       |\n+---------------------+----------------------------------------------------------------------------------------------------------------------+\n\n \n\n-   Don't forget that we can use the confidence intervals to assess whether the mean difference with Africa is significant or not\n\n## We can also use R to report each region's average life expectancy\n\n**Find the 95% CI's for the mean life expectancy for the Americas, Asia, and Europe**\n\n-   Use the base R `predict()` function (see Lesson 4 for more info)\n-   Requires specification of a `newdata` \"value\"\n\n```{r}\n#| echo: true\nnewdata <- data.frame(four_regions = c(\"Africa\", \"Americas\", \"Asia\", \"Europe\")) \n\n```\n\n::: columns\n::: {.column width=\"50%\"}\n```{r}\n#| echo: true\n(pred = predict(model1, \n                newdata=newdata, \n                interval=\"confidence\"))\n```\n:::\n\n::: {.column width=\"50%\"}\n::: fact\n::: fact-title\nInterpretations\n:::\n\n::: fact-cont\n-   The average life expectancy for countries in the Americas is `r round(pred[2,1], 2)` years (95% CI: `r round(pred[2,2], 2)`, `r round(pred[2,3], 2)`).\n-   The average life expectancy for countries in Asia is `r round(pred[3,1], 2)` years (95% CI: `r round(pred[3,2], 2)`, `r round(pred[3,3], 2)`).\n-   The average life expectancy for countries in Europe is `r round(pred[4,1], 2)` years (95% CI: `r round(pred[4,2], 2)`, `r round(pred[4,3], 2)`).\n:::\n:::\n:::\n:::\n\n## Another way to look at coefficient values\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) +  \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n```{r}\n#| echo: true\n#| code-fold: true\n\n# means of each level of `four_regions`\ngapm2_ave <- gapm2 %>% \n  group_by(four_regions) %>% \n  summarise(\n    life_ave = mean(LifeExpectancyYrs))\n\n# mean of `africa`\nmean_africa <- gapm2_ave %>% \n  filter(four_regions == \"Africa\") %>% \n  pull(life_ave)\n\n# differences in means between levels of `four_regions` and `africa`\ngapm2_ave_diff <- gapm2_ave %>% \n  mutate(`Difference with Africa` = life_ave - mean_africa) %>%\n  rename(`World regions` = four_regions, \n         `Average life expectancy` = life_ave)\n\n# At the beginning of the Rmd we loaded knitr, which is where the kable command is from\n# library(knitr)\ngapm2_ave_diff %>% kable(\n  digits = 1,\n  format = \"markdown\"\n  ) \n```\n\n$$\\widehat{\\textrm{LE}} = `r round(means_LE$mean[1], 2)` + `r round(means_LE$mean[2]-means_LE$mean[1], 2)` \\cdot I(\\text{Americas}) + `r round(means_LE$mean[3]-means_LE$mean[1], 2)` \\cdot I(\\text{Asia}) + `r round(means_LE$mean[4]-means_LE$mean[1], 2)` \\cdot I(\\text{Europe})$$\n\n# 10 minute break here?\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n\n::: lob\n4.  Change the reference level in a categorical variable for reference cell coding\n:::\n\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n\n## Reference levels\n\n**Why is `Africa` not one of the variables in the regression equation?**\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) +  \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n-   Categorical variables have to have at least 2 levels. If they have 2 levels, we call them *binary*\n\n \n\n-   We choose one level as our **reference level** to which all other levels of the categorical variable are compared\n\n    -   The levels $\\text{Americas}, \\text{Asia}, \\text{Europe}$ are compared to the level $\\text{Africa}$\n\n \n\n-   The **intercept** of the regression equation is the *mean of the outcome restricted to the reference level*\n\n    -   Recall that the intercept is the mean life expectancy of Africa, which was our reference level\n\n \n\n-   **If the categorical variable has** $r$ levels, then we need $r-1$ variables/coefficients to model it!\n\n## We can change the reference level to `Europe` (1/2)\n\n-   Suppose we want to compare the mean life expectancies of world regions to the $\\text{Europe}$ level instead of $\\text{Africa}$\n\n-   Below is the estimated regression equation for when $Africa$ is the reference level\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Americas}) +  \\widehat\\beta_2 \\cdot I(\\text{Asia}) + \\widehat\\beta_3 \\cdot I(\\text{Europe})$$\n\n-   Update the variables to make $Europe$ the reference level:\n\n$$\\widehat{\\textrm{LE}} =  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Africa}) +  \\widehat\\beta_2 \\cdot I(\\text{Americas}) + \\widehat\\beta_3 \\cdot I(\\text{Asia})$$\n\n## We can change the reference level to `Europe` (2/2)\n\n-   Now update the coefficients of the regression equation using the output below.\n\n```{r echo=FALSE}\nmean_europe <- gapm2_ave %>% \n  filter(four_regions == \"Europe\") %>% \n  pull(life_ave)\n\n# mean_europe\n\ngapm2_ave_diff2 <- gapm2_ave %>% \n  mutate(\n    `Difference with Europe` = life_ave - mean_europe\n  ) %>%\n  rename(`World regions` = four_regions, \n         `Average life expectancy` = life_ave)\n\n# At the beginning of the Rmd I loaded knitr, which is where the kable command is from\n# library(knitr)\ngapm2_ave_diff2 %>% kable(\n  digits = 2,\n  format = \"markdown\"\n  ) \n```\n\n```{r echo=FALSE}\nb0 <- mean_europe\n\ncoeff_europe <- gapm2_ave_diff2$`Difference with Europe`\n# coeff_europe\n\nb1 <- coeff_europe[1]\nb2 <- coeff_europe[2]\nb3 <- coeff_europe[3]\n# b0; b1; b2; b3\n```\n\n$$\\widehat{\\textrm{LE}} = `r round(mean_europe,2)` `r round(coeff_europe[1],2)` \\cdot I(\\text{Africa}) `r round(coeff_europe[2],2)` \\cdot I(\\text{Americas}) `r round(coeff_europe[3],2)` \\cdot I(\\text{Asia})$$\n\n## R: Change reference level to `Europe` (1/2)\n\n-   `four_regions` data type was originally a `character` - check this with `str()`\n\n```{r}\n#| echo: true\nstr(gapm$four_regions) \n```\n\n-   In order to change the reference level, we need to convert it to data type `factor`\n\n    -   I also did this at the beginning to capitalize each region\n\n```{r}\n#| echo: true\n\ngapm_ex = gapm %>% \n mutate(\n   four_regions = factor(four_regions, \n                         levels = c(\"africa\", \"americas\", \"asia\", \"europe\"), \n                         labels = c(\"Africa\", \"Americas\", \"Asia\", \"Europe\"))\n   )\nstr(gapm_ex$four_regions) \nlevels(gapm_ex$four_regions) # order of factor levels\n```\n\n## R: Change reference level to `Europe` (2/2)\n\n-   Now change the order of the factor levels\n-   Code below uses `fct_relevel()` from the `forcats` package that gets loaded as a part of the `tidyverse`\n-   *Any levels not mentioned will be left in their existing order, after the explicitly mentioned levels.*\n\n```{r}\n#| echo: true\ngapm2 <- gapm2 %>% \n  mutate(\n    four_regions = fct_relevel(four_regions, \"Europe\")\n    )\n```\n\n- Check the order:\n```{r}\n#| echo: true\n\nlevels(gapm2$four_regions)\n```\n\n## R: Run model with `Europe` as the reference level\n\n```{r}\n#| echo: true\nlevels(gapm2$four_regions)\nmodel2 <- lm(LifeExpectancyYrs ~ four_regions, data = gapm2)\ntidy(model2) %>% gt() %>% tab_options(table.font.size = 35) %>% \n  fmt_number(decimals = 2)\n```\n\n$$\\begin{aligned}\\widehat{\\textrm{LE}} &=  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot I(\\text{Africa}) +  \\widehat\\beta_2 \\cdot I(\\text{Americas}) + \\widehat\\beta_3 \\cdot I(\\text{Asia}) \\\\ \\widehat{\\textrm{LE}} &= `r round(mean_europe,2)` `r round(coeff_europe[1],2)` \\cdot I(\\text{Africa}) `r round(coeff_europe[2],2)` \\cdot I(\\text{Americas}) `r round(coeff_europe[3],2)` \\cdot I(\\text{Asia}) \\end{aligned}$$\n\n## Fitted values & residuals\n\n::: columns\n::: {.column width=\"40%\"}\nSimilar to as before:\n\n-   **Observed values** $Y$ are the values in the dataset\n\n-   **Fitted values** $\\widehat{Y}$ are the values that ~~fall on the best-fit line for a specific value of x~~ are the *means of the outcome stratified by the categorical predictor's levels*\n\n-   **Residuals** ($\\widehat{\\epsilon} = Y - \\widehat{Y}$) are the differences between the two\n:::\n\n::: {.column width=\"60%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = four_regions, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"World region\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. world region\",\n       caption = \"Diamonds = region averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## Fitted values are the same as the means\n\n```{r fig.height=6, fig.width=6, warning=F}\n#| echo: true\n#| fig-align: center\n\nm1_aug <- augment(model1)\n\nggplot(m1_aug, aes(x = four_regions, y = .fitted)) + geom_point() +\n  theme(axis.text = element_text(size = 22), axis.title = element_text(size = 22))\n```\n\n\n## Residual plots (now the spread within each region)\n\n```{r fig.height=6, fig.width=6, warning=F}\n#| echo: true\n#| fig-align: center\nggplot(m1_aug, aes(x=.resid)) + geom_histogram() + \n  theme(axis.text = element_text(size = 22), title = element_text(size = 22))\n```\n\n## Poll Everywhere Question 3\n\n\n# Learning Objectives\n\n1.  Understand why we need a new way to code categorical variables compared to continuous variables\n2.  Write the regression equation for a categorical variable using reference cell coding\n3.  Calculate and interpret coefficients for reference cell coding\n4.  Change the reference level in a categorical variable for reference cell coding\n\n::: lob\n5.  Create new variables and interpret coefficient for ordinal / scoring coding\n:::\n\n## Let's look at life expectancy vs. four income levels\n\n-   [Gapminder discusses individual income levels](https://www.gapminder.org/fw/income-levels/)\n\n \n\n-   **Income levels for a country** is based on average GDP per capita, and grouped into:\n\n    -   Low income\n    \n    -   Lower middle income\n    \n    -   Upper middle income\n    \n    -   High income\n\n## Visualizing the ordinal variable, income levels\n\n::: columns\n::: {.column width=\"40%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = income_levels, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n\n::: {.column width=\"60%\"}\nA few changes needed:\n\n-   Put the income levels in order\n\n```{r}\n#| echo: true\ngapm2 = gapm2 %>%\n mutate(income_levels = factor(income_levels, \n            ordered = T, \n            levels = c(\"Low income\", \n            \"Lower middle income\", \n            \"Upper middle income\", \n            \"High income\")))\n```\n\n-   Make the income levels readable\n\n    -   [How to Rotate Axis Labels in ggplot2?](https://www.r-bloggers.com/2021/09/how-to-rotate-axis-labels-in-ggplot2/)\n:::\n:::\n\n## Much better: Visualizing the ordinal variable, income levels {.smaller}\n\n::: columns\n::: {.column width=\"60%\"}\n```{r fig.height=8, fig.width=8, warning=F, fig.align='center'}\n#| eval: false\n#| echo: true\nggplot(gapm2, aes(x = income_levels, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20), \n        axis.text.x=element_text(angle = 20, vjust = 1, hjust=1))\n```\n:::\n\n::: {.column width=\"40%\"}\n```{r fig.height=8, fig.width=7, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = income_levels, y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20), \n        axis.text.x=element_text(angle = 20, vjust = 1, hjust=1))\n```\n:::\n:::\n\n## How can we code this variable?\n\nWe have two options:\n\n::: columns\n::: column\n::: definition\n::: def-title\nTreat the levels as nominal, and use reference cell coding\n:::\n\n::: def-cont\n-   Like we did with world regions\n\n-   This option will not break the linearity assumption\n\n-   For $g$ categories of the variable, we will have $g-1$ coefficients to estimate\n:::\n:::\n:::\n\n::: column\n::: proof1\n::: proof-title\nUse the ordinal values to score the levels and treat as a numerical variable\n:::\n\n::: proof-cont\n-   Even if a variable is inherently ordered, we need to check that linearity holds if categories are represented as numbers\n\n-   This way of coding preserves more power in the model (less coefficients to estimate means more power)\n\n-   Only one coefficient to estimate\n:::\n:::\n:::\n:::\n\n## Some important considerations when scoring ordinal variables\n\n-   Even if a variable is inherently ordered, we need to check that linearity holds if categories are represented as numbers (more in next lessons)\n    - Linearity is an assumption of linear regression: that the relationship between X and Y is linear\n\n \n\n-   Assumes differences between adjacent groups are equal\n\n    -   Income levels are pre-set groups by Gapminder\n    -   Might be hard to interpret \"every 1-level increase in income level\"\n   \n \n \n-   Is the variable part of the main relationship that you are investigating? (even if linearity holds)\n\n    -   If yes, consider leaving as reference cell coding unless the interpretation makes sense\n    \n    -   If no, and just needed as an adjustment in your model, then power benefit of scoring might be worth it!\n\n## Check that linearity holds for income levels\n\n::: columns\n::: {.column width=\"40%\"}\n-   Using visual assessment, linearity holds for our income levels (more in next lessons)\n\n-   We can use the ordinal encoding for income levels\n:::\n\n::: {.column width=\"60%\"}\n```{r fig.height=8, fig.width=7.5, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = as.numeric(income_levels), y = LifeExpectancyYrs)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  geom_smooth(method = lm, se = FALSE) + \n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n:::\n\n## Poll Everywhere Question 4\n\n## Ordinal coding / Scoring\n\n-   Map each income level to a number\n\n-   Usually start at 1\n\n| Income Level        | Score |\n|---------------------|-------|\n| Low income          | 1     |\n| Lower middle income | 2     |\n| Upper middle income | 3     |\n| High income         | 4     |\n\n```{r}\n#| echo: true\ngapm2 = gapm2 %>%\n  mutate(income_num = as.numeric(income_levels))\nstr(gapm2$income_num)\n```\n\n## Run the model with the scored income\n\n```{r}\n#| echo: true\n\nmod_inc2 = lm(LifeExpectancyYrs ~ income_num, data = gapm2)\ntidy(mod_inc2) %>% gt() %>% tab_options(table.font.size = 37) %>%\n  fmt_number(decimals = 2)\n```\n\n$$\\begin{aligned}\n\\widehat{\\textrm{LE}} &=  \\widehat\\beta_0 + \\widehat\\beta_1 \\cdot \\text{Income level} \\\\\n\\widehat{\\textrm{LE}} &=  54.01 + 6.25 \\cdot \\text{Income level}\n\\end{aligned}$$\n\n-   Keep in mind: We cannot calculate the expected outcome outside of the scoring values\n\n    -   For example, we cannot find the mean life expectancy for an income level of 1.5\n\n## Interpreting the model\n\n```{r}\ntidy(mod_inc2, conf.int=T) %>% gt() %>% tab_options(table.font.size = 37) %>%\n  fmt_number(decimals = 2)\n```\n\n$$\\widehat{\\textrm{LE}} =  54.01 + 6.25 \\cdot \\text{Income level}$$\n\n-   **Interpreting the intercept:** At an income level of 0, mean life expectancy is 54.01 (95% CI: 51.92, 56.10).\n\n    -   Note: this does not make sense because there is no income level of 0!\n    \n-   **Interpreting the coefficient for income:** For every 1-level increase in income level, mean life expectancy increases 6.25 years (95% CI: 5.52, 6.98).\n\n## What if life expectancy vs. income level looked like this?\n\n::: columns\n::: {.column width=\"50%\"}\n```{r}\nset.seed(40)\ngapm2 = gapm2 %>% rowwise() %>% \n  mutate(life_exp_sim = rnorm(1, mean = 23*log(8*(income_num-0.7)), sd=5))\n```\n\n```{r fig.height=8, fig.width=7.5, warning=F, fig.align='center'}\n#| echo: false\nggplot(gapm2, aes(x = income_num, y = life_exp_sim)) +\n  geom_jitter(size = 1, alpha = .6, width = 0.2) +\n  stat_summary(fun = mean, geom = \"point\", size = 8, shape = 18) +\n  geom_smooth(method = lm, se = FALSE) + \n  labs(x = \"Income levels\", \n       y = \"Country life expectancy (years)\",\n       title = \"Life expectancy vs. income levels\",\n       caption = \"Diamonds = Income level averages\") +\n  theme(axis.title = element_text(size = 20), \n        axis.text = element_text(size = 20), \n        title = element_text(size = 20))\n```\n:::\n\n::: {.column width=\"50%\"}\n-   No longer maintaining the linearity assumption\n-   Need to use reference cell coding\n\n \n\n-   We would fit the following model: \n$$\\begin{aligned}\n\\textrm{LE} = & \\beta_0 + \\beta_1 \\cdot I(\\text{Lower middle income}) + \\\\ & \\beta_2 \\cdot I(\\text{Upper middle income}) + \\\\ & \\beta_3 \\cdot I(\\text{High income}) + \\epsilon\n\\end{aligned}$$\n:::\n:::\n\n## If time...\n\n[Let's walk through categorical variables that have multiple selections](https://weallcount.com/2022/10/27/4-approaches-to-multiple-race-questions/)\n\n-   So each group is not mutually exclusive\n\n-   We could make an indicator for each category, but individuals could be a part of multiple categories\n\n \n\n-   Also, thinking about income levels - can we combine two groups to make one??\n\n"},"formats":{"revealjs":{"identifier":{"display-name":"RevealJS","target-format":"revealjs","base-format":"revealjs"},"execute":{"fig-width":10,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","html-math-method":"mathjax","slide-level":2,"to":"revealjs","highlight-style":"ayu","output-file":"05_Cat_covariates.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":false,"quarto-version":"1.8.25","auto-stretch":true,"title":"Lesson 5: SLR-ish: Categorical Covariates","author":"Meike Niederhausen and Nicky Wakim","title-slide-attributes":{"data-background-color":"#213c96"},"date":"01/22/2025","categories":["Week 6"],"theme":"../simple_NW.scss","chalkboard":true,"slideNumber":true,"showSlideNumber":"all","width":1955,"height":1100,"footer":"Lesson 5: Categorical Covariates"}}},"projectFormats":["html"]}